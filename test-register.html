<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>注册功能测试</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .form-group { margin: 10px 0; }
        label { display: block; margin-bottom: 5px; }
        input { width: 300px; padding: 8px; margin-bottom: 10px; }
        button { padding: 10px 20px; background: #007bff; color: white; border: none; cursor: pointer; }
        button:hover { background: #0056b3; }
        .result { margin-top: 20px; padding: 10px; background: #f8f9fa; border: 1px solid #dee2e6; }
        .error { background: #f8d7da; border-color: #f5c6cb; color: #721c24; }
        .success { background: #d4edda; border-color: #c3e6cb; color: #155724; }
    </style>
</head>
<body>
    <h1>EcoPaste 注册功能测试</h1>
    
    <form id="registerForm">
        <div class="form-group">
            <label for="email">邮箱:</label>
            <input type="email" id="email" name="email" placeholder="请输入邮箱" required>
        </div>
        
        <div class="form-group">
            <label for="password">密码:</label>
            <input type="password" id="password" name="password" placeholder="请输入密码" required>
        </div>
        
        <div class="form-group">
            <label for="confirmPassword">确认密码:</label>
            <input type="password" id="confirmPassword" name="confirmPassword" placeholder="请再次输入密码" required>
        </div>
        
        <div class="form-group">
            <div style="background: #f0f2f5; padding: 12px; border-radius: 6px; border-left: 4px solid #1890ff;">
                <strong>📱 自动设备名称:</strong>
                <div id="deviceNamePreview" style="margin-top: 8px; font-family: monospace; color: #666;">正在获取...</div>
                <small style="color: #666; margin-top: 4px; display: block;">设备名称将自动获取，无需手动输入</small>
            </div>
        </div>
        
        <button type="submit">注册</button>
    </form>
    
    <div id="result" class="result" style="display: none;"></div>

    <script>
        // 模拟前端的注册逻辑
        class TestSyncPlugin {
            constructor() {
                this.baseUrl = 'http://localhost:3001';
            }
            
            // 自动获取设备名称的函数
            async getDeviceName() {
                try {
                    // 模拟获取详细设备信息
                    const deviceInfo = this.getDetailedDeviceInfo();
                    
                    // 生成增强格式："用户名@设备型号 (平台) [用户信息-设备ID] - 主机名"
                    const deviceIdentifier = deviceInfo.userInfo ? 
                        `[${deviceInfo.userInfo}-${deviceInfo.deviceId}]` : 
                        `[${deviceInfo.deviceId}]`;
                    
                    if (deviceInfo.hostname && deviceInfo.hostname !== 'localhost') {
                        return `${deviceInfo.username}@${deviceInfo.model} (${deviceInfo.platform}) ${deviceIdentifier} - ${deviceInfo.hostname}`;
                    } else {
                        return `${deviceInfo.username}@${deviceInfo.model} (${deviceInfo.platform}) ${deviceIdentifier}`;
                    }
                } catch (error) {
                    console.error('获取设备名称失败:', error);
                    return `EcoPaste-Device-${Date.now().toString().slice(-6)}`;
                }
            },
            
            // 获取详细设备信息
            getDetailedDeviceInfo() {
                const platform = navigator.platform || navigator.userAgent;
                let platformName = 'Desktop';
                let deviceModel = 'Computer';
                let username = 'User';
                let hostname = 'MyComputer';
                let userInfo = '';
                let deviceId = '';
                
                // 生成设备ID
                deviceId = this.generateDeviceId();
                
                // 获取用户额外信息
                userInfo = this.getUserExtraInfo();
                
                // 检测平台和生成相应信息
                if (platform.includes('Mac')) {
                    platformName = 'Mac';
                    deviceModel = this.getMacDeviceModel();
                    username = this.getMacUsername();
                    hostname = this.getMacHostname();
                } else if (platform.includes('Win')) {
                    platformName = 'Windows';
                    deviceModel = this.getWindowsDeviceModel();
                    username = this.getWindowsUsername();
                    hostname = this.getWindowsHostname();
                } else if (platform.includes('Linux')) {
                    platformName = 'Linux';
                    deviceModel = this.getLinuxDeviceModel();
                    username = this.getLinuxUsername();
                    hostname = this.getLinuxHostname();
                }
                
                return {
                    username,
                    model: deviceModel,
                    platform: platformName,
                    hostname,
                    userInfo,
                    deviceId
                };
            }
            
            // Mac 设备信息模拟
            getMacDeviceModel() {
                const models = ['MacBook-Pro-M3', 'MacBook-Air-M2', 'iMac-24', 'Mac-Studio', 'MacBook-Pro-Intel'];
                return models[Math.floor(Math.random() * models.length)];
            }
            
            getMacUsername() {
                const usernames = ['john.doe', 'admin', 'developer', 'user'];
                return usernames[Math.floor(Math.random() * usernames.length)];
            }
            
            getMacHostname() {
                const hostnames = ['MacBook-Pro', 'iMac-Office', 'Mac-Studio-Home', 'MacBook-Air'];
                return hostnames[Math.floor(Math.random() * hostnames.length)];
            }
            
            // Windows 设备信息模拟
            getWindowsDeviceModel() {
                const models = ['Dell-OptiPlex-7090', 'HP-EliteBook-840', 'Lenovo-ThinkPad-X1', 'Surface-Laptop-5', 'ASUS-VivoBook'];
                return models[Math.floor(Math.random() * models.length)];
            }
            
            getWindowsUsername() {
                const usernames = ['Administrator', 'office-user', 'dev-team', 'workstation'];
                return usernames[Math.floor(Math.random() * usernames.length)];
            }
            
            getWindowsHostname() {
                const hostnames = ['DESKTOP-ABC123', 'OFFICE-PC-01', 'DEV-MACHINE', 'WORKSTATION-07'];
                return hostnames[Math.floor(Math.random() * hostnames.length)];
            }
            
            // Linux 设备信息模拟
            getLinuxDeviceModel() {
                const models = ['Ubuntu-Desktop', 'CentOS-Server', 'Arch-Workstation', 'Debian-Dev', 'Fedora-Laptop'];
                return models[Math.floor(Math.random() * models.length)];
            }
            
            getLinuxUsername() {
                const usernames = ['developer', 'sysadmin', 'ubuntu', 'root'];
                return usernames[Math.floor(Math.random() * usernames.length)];
            }
            
            getLinuxHostname() {
                const hostnames = ['ubuntu-server', 'dev-box', 'linux-workstation', 'fedora-laptop'];
                return hostnames[Math.floor(Math.random() * hostnames.length)];
            },
            
            // 生成设备唯一标识符
            generateDeviceId() {
                try {
                    // 基于多种浏览器特征生成相对稳定的设备ID
                    const features = [
                        navigator.userAgent || '',
                        navigator.platform || '',
                        screen.width?.toString() || '',
                        screen.height?.toString() || '',
                        screen.colorDepth?.toString() || '',
                        new Date().getTimezoneOffset().toString(),
                        navigator.language || '',
                        navigator.hardwareConcurrency?.toString() || ''
                    ].join('|');
                    
                    // 生成哈希
                    let hash = 0;
                    for (let i = 0; i < features.length; i++) {
                        hash = ((hash << 5) - hash + features.charCodeAt(i)) & 0xffffffff;
                    }
                    
                    // 转换为6位短ID
                    return Math.abs(hash).toString(36).substring(0, 6).toUpperCase();
                } catch (error) {
                    console.error('生成设备ID失败:', error);
                    return Math.random().toString(36).substring(2, 8).toUpperCase();
                }
            },
            
            // 获取用户额外信息
            getUserExtraInfo() {
                try {
                    const info = [];
                    
                    // 检测时区
                    try {
                        const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
                        if (timezone) {
                            // 简化时区信息
                            const shortTimezone = timezone.split('/').pop() || timezone;
                            info.push(shortTimezone);
                        }
                    } catch (e) {
                        // 忽略时区获取错误
                    }
                    
                    // 检测语言偏好
                    try {
                        const lang = navigator.language?.split('-')[0];
                        if (lang && lang !== 'en') {
                            info.push(lang.toUpperCase());
                        }
                    } catch (e) {
                        // 忽略语言检测错误
                    }
                    
                    // 检测屏幕分辨率等级
                    try {
                        const screenArea = (screen.width || 0) * (screen.height || 0);
                        if (screenArea > 8000000) { // 4K+
                            info.push('4K');
                        } else if (screenArea > 2000000) { // 1080p+
                            info.push('HD');
                        }
                    } catch (e) {
                        // 忽略屏幕检测错误
                    }
                    
                    return info.join('-');
                } catch (error) {
                    console.error('获取用户额外信息失败:', error);
                    return '';
                }
            },

            async register(data) {
                // 验证必填字段
                if (!data.email || !data.password) {
                    throw new Error('邮箱和密码不能为空');
                }
                
                // 自动获取设备名称
                const deviceName = await this.getDeviceName();
                
                const requestData = {
                    username: data.email, // 使用email作为username
                    password: data.password,
                    email: data.email,
                    deviceName: deviceName,
                    deviceType: 'desktop',
                    platform: navigator.platform
                };
                
                console.log('发送注册请求:', requestData);
                
                const response = await fetch(`${this.baseUrl}/api/auth/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });
                
                if (!response.ok) {
                    const error = await response.json().catch(() => ({ message: response.statusText }));
                    throw new Error(error.error || error.message || `HTTP ${response.status}`);
                }
                
                return await response.json();
            }
        }
        
        const syncPlugin = new TestSyncPlugin();
        
        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const data = {
                email: formData.get('email'),
                password: formData.get('password'),
                confirmPassword: formData.get('confirmPassword')
            };
            
            const resultDiv = document.getElementById('result');
            
            // 前端验证
            if (!data.email || !data.password) {
                showResult('请填写邮箱和密码', 'error');
                return;
            }
            
            if (data.password !== data.confirmPassword) {
                showResult('密码确认不匹配', 'error');
                return;
            }
            
            try {
                const response = await syncPlugin.register(data);
                console.log('注册响应:', response);
                showResult('注册成功！', 'success');
                
                // 重置表单
                document.getElementById('registerForm').reset();
                // 更新设备名称预览
                updateDeviceNamePreview();
                
            } catch (error) {
                console.error('注册失败:', error);
                showResult(`注册失败: ${error.message}`, 'error');
            }
        });
        
        function showResult(message, type) {
            const resultDiv = document.getElementById('result');
            resultDiv.textContent = message;
            resultDiv.className = `result ${type}`;
            resultDiv.style.display = 'block';
        }
        
        // 更新设备名称预览
        async function updateDeviceNamePreview() {
            try {
                const deviceName = await syncPlugin.getDeviceName();
                document.getElementById('deviceNamePreview').textContent = deviceName;
            } catch (error) {
                document.getElementById('deviceNamePreview').textContent = 'EcoPaste Desktop';
            }
        }
        
        // 初始化时更新设备名称预览
        window.addEventListener('load', () => {
            updateDeviceNamePreview();
        });
    </script>
</body>
</html>