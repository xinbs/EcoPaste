<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ³¨å†ŒåŠŸèƒ½æµ‹è¯•</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .form-group { margin: 10px 0; }
        label { display: block; margin-bottom: 5px; }
        input { width: 300px; padding: 8px; margin-bottom: 10px; }
        button { padding: 10px 20px; background: #007bff; color: white; border: none; cursor: pointer; }
        button:hover { background: #0056b3; }
        .result { margin-top: 20px; padding: 10px; background: #f8f9fa; border: 1px solid #dee2e6; }
        .error { background: #f8d7da; border-color: #f5c6cb; color: #721c24; }
        .success { background: #d4edda; border-color: #c3e6cb; color: #155724; }
    </style>
</head>
<body>
    <h1>EcoPaste æ³¨å†ŒåŠŸèƒ½æµ‹è¯•</h1>
    
    <form id="registerForm">
        <div class="form-group">
            <label for="email">é‚®ç®±:</label>
            <input type="email" id="email" name="email" placeholder="è¯·è¾“å…¥é‚®ç®±" required>
        </div>
        
        <div class="form-group">
            <label for="password">å¯†ç :</label>
            <input type="password" id="password" name="password" placeholder="è¯·è¾“å…¥å¯†ç " required>
        </div>
        
        <div class="form-group">
            <label for="confirmPassword">ç¡®è®¤å¯†ç :</label>
            <input type="password" id="confirmPassword" name="confirmPassword" placeholder="è¯·å†æ¬¡è¾“å…¥å¯†ç " required>
        </div>
        
        <div class="form-group">
            <div style="background: #f0f2f5; padding: 12px; border-radius: 6px; border-left: 4px solid #1890ff;">
                <strong>ğŸ“± è‡ªåŠ¨è®¾å¤‡åç§°:</strong>
                <div id="deviceNamePreview" style="margin-top: 8px; font-family: monospace; color: #666;">æ­£åœ¨è·å–...</div>
                <small style="color: #666; margin-top: 4px; display: block;">è®¾å¤‡åç§°å°†è‡ªåŠ¨è·å–ï¼Œæ— éœ€æ‰‹åŠ¨è¾“å…¥</small>
            </div>
        </div>
        
        <button type="submit">æ³¨å†Œ</button>
    </form>
    
    <div id="result" class="result" style="display: none;"></div>

    <script>
        // æ¨¡æ‹Ÿå‰ç«¯çš„æ³¨å†Œé€»è¾‘
        class TestSyncPlugin {
            constructor() {
                this.baseUrl = 'http://localhost:3001';
            }
            
            // è‡ªåŠ¨è·å–è®¾å¤‡åç§°çš„å‡½æ•°
            async getDeviceName() {
                try {
                    // æ¨¡æ‹Ÿè·å–è¯¦ç»†è®¾å¤‡ä¿¡æ¯
                    const deviceInfo = this.getDetailedDeviceInfo();
                    
                    // ç”Ÿæˆå¢å¼ºæ ¼å¼ï¼š"ç”¨æˆ·å@è®¾å¤‡å‹å· (å¹³å°) [ç”¨æˆ·ä¿¡æ¯-è®¾å¤‡ID] - ä¸»æœºå"
                    const deviceIdentifier = deviceInfo.userInfo ? 
                        `[${deviceInfo.userInfo}-${deviceInfo.deviceId}]` : 
                        `[${deviceInfo.deviceId}]`;
                    
                    if (deviceInfo.hostname && deviceInfo.hostname !== 'localhost') {
                        return `${deviceInfo.username}@${deviceInfo.model} (${deviceInfo.platform}) ${deviceIdentifier} - ${deviceInfo.hostname}`;
                    } else {
                        return `${deviceInfo.username}@${deviceInfo.model} (${deviceInfo.platform}) ${deviceIdentifier}`;
                    }
                } catch (error) {
                    console.error('è·å–è®¾å¤‡åç§°å¤±è´¥:', error);
                    return `EcoPaste-Device-${Date.now().toString().slice(-6)}`;
                }
            },
            
            // è·å–è¯¦ç»†è®¾å¤‡ä¿¡æ¯
            getDetailedDeviceInfo() {
                const platform = navigator.platform || navigator.userAgent;
                let platformName = 'Desktop';
                let deviceModel = 'Computer';
                let username = 'User';
                let hostname = 'MyComputer';
                let userInfo = '';
                let deviceId = '';
                
                // ç”Ÿæˆè®¾å¤‡ID
                deviceId = this.generateDeviceId();
                
                // è·å–ç”¨æˆ·é¢å¤–ä¿¡æ¯
                userInfo = this.getUserExtraInfo();
                
                // æ£€æµ‹å¹³å°å’Œç”Ÿæˆç›¸åº”ä¿¡æ¯
                if (platform.includes('Mac')) {
                    platformName = 'Mac';
                    deviceModel = this.getMacDeviceModel();
                    username = this.getMacUsername();
                    hostname = this.getMacHostname();
                } else if (platform.includes('Win')) {
                    platformName = 'Windows';
                    deviceModel = this.getWindowsDeviceModel();
                    username = this.getWindowsUsername();
                    hostname = this.getWindowsHostname();
                } else if (platform.includes('Linux')) {
                    platformName = 'Linux';
                    deviceModel = this.getLinuxDeviceModel();
                    username = this.getLinuxUsername();
                    hostname = this.getLinuxHostname();
                }
                
                return {
                    username,
                    model: deviceModel,
                    platform: platformName,
                    hostname,
                    userInfo,
                    deviceId
                };
            }
            
            // Mac è®¾å¤‡ä¿¡æ¯æ¨¡æ‹Ÿ
            getMacDeviceModel() {
                const models = ['MacBook-Pro-M3', 'MacBook-Air-M2', 'iMac-24', 'Mac-Studio', 'MacBook-Pro-Intel'];
                return models[Math.floor(Math.random() * models.length)];
            }
            
            getMacUsername() {
                const usernames = ['john.doe', 'admin', 'developer', 'user'];
                return usernames[Math.floor(Math.random() * usernames.length)];
            }
            
            getMacHostname() {
                const hostnames = ['MacBook-Pro', 'iMac-Office', 'Mac-Studio-Home', 'MacBook-Air'];
                return hostnames[Math.floor(Math.random() * hostnames.length)];
            }
            
            // Windows è®¾å¤‡ä¿¡æ¯æ¨¡æ‹Ÿ
            getWindowsDeviceModel() {
                const models = ['Dell-OptiPlex-7090', 'HP-EliteBook-840', 'Lenovo-ThinkPad-X1', 'Surface-Laptop-5', 'ASUS-VivoBook'];
                return models[Math.floor(Math.random() * models.length)];
            }
            
            getWindowsUsername() {
                const usernames = ['Administrator', 'office-user', 'dev-team', 'workstation'];
                return usernames[Math.floor(Math.random() * usernames.length)];
            }
            
            getWindowsHostname() {
                const hostnames = ['DESKTOP-ABC123', 'OFFICE-PC-01', 'DEV-MACHINE', 'WORKSTATION-07'];
                return hostnames[Math.floor(Math.random() * hostnames.length)];
            }
            
            // Linux è®¾å¤‡ä¿¡æ¯æ¨¡æ‹Ÿ
            getLinuxDeviceModel() {
                const models = ['Ubuntu-Desktop', 'CentOS-Server', 'Arch-Workstation', 'Debian-Dev', 'Fedora-Laptop'];
                return models[Math.floor(Math.random() * models.length)];
            }
            
            getLinuxUsername() {
                const usernames = ['developer', 'sysadmin', 'ubuntu', 'root'];
                return usernames[Math.floor(Math.random() * usernames.length)];
            }
            
            getLinuxHostname() {
                const hostnames = ['ubuntu-server', 'dev-box', 'linux-workstation', 'fedora-laptop'];
                return hostnames[Math.floor(Math.random() * hostnames.length)];
            },
            
            // ç”Ÿæˆè®¾å¤‡å”¯ä¸€æ ‡è¯†ç¬¦
            generateDeviceId() {
                try {
                    // åŸºäºå¤šç§æµè§ˆå™¨ç‰¹å¾ç”Ÿæˆç›¸å¯¹ç¨³å®šçš„è®¾å¤‡ID
                    const features = [
                        navigator.userAgent || '',
                        navigator.platform || '',
                        screen.width?.toString() || '',
                        screen.height?.toString() || '',
                        screen.colorDepth?.toString() || '',
                        new Date().getTimezoneOffset().toString(),
                        navigator.language || '',
                        navigator.hardwareConcurrency?.toString() || ''
                    ].join('|');
                    
                    // ç”Ÿæˆå“ˆå¸Œ
                    let hash = 0;
                    for (let i = 0; i < features.length; i++) {
                        hash = ((hash << 5) - hash + features.charCodeAt(i)) & 0xffffffff;
                    }
                    
                    // è½¬æ¢ä¸º6ä½çŸ­ID
                    return Math.abs(hash).toString(36).substring(0, 6).toUpperCase();
                } catch (error) {
                    console.error('ç”Ÿæˆè®¾å¤‡IDå¤±è´¥:', error);
                    return Math.random().toString(36).substring(2, 8).toUpperCase();
                }
            },
            
            // è·å–ç”¨æˆ·é¢å¤–ä¿¡æ¯
            getUserExtraInfo() {
                try {
                    const info = [];
                    
                    // æ£€æµ‹æ—¶åŒº
                    try {
                        const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
                        if (timezone) {
                            // ç®€åŒ–æ—¶åŒºä¿¡æ¯
                            const shortTimezone = timezone.split('/').pop() || timezone;
                            info.push(shortTimezone);
                        }
                    } catch (e) {
                        // å¿½ç•¥æ—¶åŒºè·å–é”™è¯¯
                    }
                    
                    // æ£€æµ‹è¯­è¨€åå¥½
                    try {
                        const lang = navigator.language?.split('-')[0];
                        if (lang && lang !== 'en') {
                            info.push(lang.toUpperCase());
                        }
                    } catch (e) {
                        // å¿½ç•¥è¯­è¨€æ£€æµ‹é”™è¯¯
                    }
                    
                    // æ£€æµ‹å±å¹•åˆ†è¾¨ç‡ç­‰çº§
                    try {
                        const screenArea = (screen.width || 0) * (screen.height || 0);
                        if (screenArea > 8000000) { // 4K+
                            info.push('4K');
                        } else if (screenArea > 2000000) { // 1080p+
                            info.push('HD');
                        }
                    } catch (e) {
                        // å¿½ç•¥å±å¹•æ£€æµ‹é”™è¯¯
                    }
                    
                    return info.join('-');
                } catch (error) {
                    console.error('è·å–ç”¨æˆ·é¢å¤–ä¿¡æ¯å¤±è´¥:', error);
                    return '';
                }
            },

            async register(data) {
                // éªŒè¯å¿…å¡«å­—æ®µ
                if (!data.email || !data.password) {
                    throw new Error('é‚®ç®±å’Œå¯†ç ä¸èƒ½ä¸ºç©º');
                }
                
                // è‡ªåŠ¨è·å–è®¾å¤‡åç§°
                const deviceName = await this.getDeviceName();
                
                const requestData = {
                    username: data.email, // ä½¿ç”¨emailä½œä¸ºusername
                    password: data.password,
                    email: data.email,
                    deviceName: deviceName,
                    deviceType: 'desktop',
                    platform: navigator.platform
                };
                
                console.log('å‘é€æ³¨å†Œè¯·æ±‚:', requestData);
                
                const response = await fetch(`${this.baseUrl}/api/auth/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });
                
                if (!response.ok) {
                    const error = await response.json().catch(() => ({ message: response.statusText }));
                    throw new Error(error.error || error.message || `HTTP ${response.status}`);
                }
                
                return await response.json();
            }
        }
        
        const syncPlugin = new TestSyncPlugin();
        
        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const data = {
                email: formData.get('email'),
                password: formData.get('password'),
                confirmPassword: formData.get('confirmPassword')
            };
            
            const resultDiv = document.getElementById('result');
            
            // å‰ç«¯éªŒè¯
            if (!data.email || !data.password) {
                showResult('è¯·å¡«å†™é‚®ç®±å’Œå¯†ç ', 'error');
                return;
            }
            
            if (data.password !== data.confirmPassword) {
                showResult('å¯†ç ç¡®è®¤ä¸åŒ¹é…', 'error');
                return;
            }
            
            try {
                const response = await syncPlugin.register(data);
                console.log('æ³¨å†Œå“åº”:', response);
                showResult('æ³¨å†ŒæˆåŠŸï¼', 'success');
                
                // é‡ç½®è¡¨å•
                document.getElementById('registerForm').reset();
                // æ›´æ–°è®¾å¤‡åç§°é¢„è§ˆ
                updateDeviceNamePreview();
                
            } catch (error) {
                console.error('æ³¨å†Œå¤±è´¥:', error);
                showResult(`æ³¨å†Œå¤±è´¥: ${error.message}`, 'error');
            }
        });
        
        function showResult(message, type) {
            const resultDiv = document.getElementById('result');
            resultDiv.textContent = message;
            resultDiv.className = `result ${type}`;
            resultDiv.style.display = 'block';
        }
        
        // æ›´æ–°è®¾å¤‡åç§°é¢„è§ˆ
        async function updateDeviceNamePreview() {
            try {
                const deviceName = await syncPlugin.getDeviceName();
                document.getElementById('deviceNamePreview').textContent = deviceName;
            } catch (error) {
                document.getElementById('deviceNamePreview').textContent = 'EcoPaste Desktop';
            }
        }
        
        // åˆå§‹åŒ–æ—¶æ›´æ–°è®¾å¤‡åç§°é¢„è§ˆ
        window.addEventListener('load', () => {
            updateDeviceNamePreview();
        });
    </script>
</body>
</html>